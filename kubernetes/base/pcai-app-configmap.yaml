# kubernetes/base/pcai-app-configmap.yaml
# This ConfigMap externalizes configuration and knowledge base files from the container image.
# It will be mounted as volumes into the PCAI Application pod.

apiVersion: v1
kind: ConfigMap
metadata:
  name: pcai-app-config
  # The namespace will be applied by the 'kustomization.yaml' file
data:
  # Key 1: The main configuration file for the entire application.
  # Note the updated Kubernetes service names for internal communication.
  demo_config.yaml: |
    # ----------------------------------------------------------------------
    # Configuration for the AI-Driven Predictive Maintenance Demo (for K8s)
    # ----------------------------------------------------------------------
    company_name_short: "DemoCorpK8s"

    iot_sensor_simulator:
      asset_id_prefix: "{company_name_short}_Turbine"
      default_asset_number: 7
      data_interval_seconds: 2
      base_temp_c: 42.0

    aruba_edge_simulator:
      device_id_template: "Edge_Sim_{company_name_short}_Node{id:03d}"
      default_device_id_num: 1
      # This value is overridden by the PCAI_AGENT_TRIGGER_ENDPOINT env var in the K8s deployment
      pcai_agent_trigger_endpoint: "http://pcai-app-service:5000/api/v1/analyze_trigger"
      thresholds:
        temperature_critical_c: 55.0
        vibration_anomaly_amp_g: 1.5
        acoustic_critical_band_db: 70.0
      opsramp:
        metrics_endpoint: "SIMULATED_OPSRAMP_API/edge/metrics"
        events_endpoint: "SIMULATED_OPSRAMP_API/edge/events"

    pcai_app:
      agent_id_prefix_template: "PCAI_Agent_{company_name_short}"
      listen_host: "0.0.0.0"
      listen_port: 5000
      knowledge_base_path: "/app/knowledge_base_files" # The path inside the container where this ConfigMap is mounted
      
      llm_config:
        provider: "ollama"
        ollama:
          model_name: "llama3:8b"
          # This URL uses the K8s service name, not localhost.
          api_base_url: "http://ollama-service:11434"
          request_timeout_seconds: 180

      opsramp:
        env_var_tenant_id: "OPSRAMP_TENANT_ID"
        env_var_api_key: "OPSRAMP_API_KEY"
        env_var_api_secret: "OPSRAMP_API_SECRET"
        api_hostname: "hpekaops.api.pov.opsramp.com"
        token_endpoint_path: "/tenancy/auth/oauth/token"
        alert_endpoint_path: "/api/v2/tenants/{tenantId}/alerts"
        # IMPORTANT: Replace with the unique ID of the resource you created in OpsRamp
        turbine_resource_id: "957836fe-7986-46da-bc28-b5d5cca08c85"

      servicenow:
        # IMPORTANT: Replace with YOUR actual ServiceNow developer instance HOSTNAME
        instance_hostname: "dev194183.service-now.com"
        env_var_api_user: "SERVICENOW_API_USER"
        env_var_api_password: "SERVICENOW_API_PASSWORD"
        target_table: "incident"
        default_assignment_group: "Mechanical Maintenance Team"
        custom_fields:
          source_system: "u_source_system"
          ai_diagnosis_confidence: "u_ai_diagnosis_confidence"
          ai_reasoning: "u_ai_reasoning"
          recommended_actions: "u_ai_recommended_actions"
          required_parts: "u_ai_required_parts"

      diagnosis:
        confidence_threshold_for_action: 0.70

  # Key 2: The technical manual knowledge base file
  technical_manual_extracts.txt: |
    Wind Turbine Generator - Model GRX-II - Operations & Maintenance Manual

    Document Version: 4.7.2
    Last Updated: 2024-01-15
    Manufacturer: AeroGen Dynamics Ltd.

    Chapter 7: Troubleshooting Common Faults
    7.2. Generator Overheating
    Continuous operation above nominal temperature (85°C internal winding) can degrade insulation and reduce generator lifespan. Verify cooling system functionality.

    7.3. Vibration Analysis and Fault Signatures
    The GRX-II is equipped with multiple vibration sensors. Section 7.3: High-frequency vibrations (115-125Hz) with harmonic sidebands often indicate early-stage gear tooth pitting. This is particularly relevant for auxiliary systems.

  # Key 3: The repair history knowledge base file
  turbine_repair_history_logs.txt: |
    Turbine Maintenance & Repair Log - Master Record

    Asset ID: DemoCorp_Turbine_004 (identical model to DemoCorp_Turbine_007)
    Date: 2024-03-03
    Work Order: WO2024030002
    Issue: Critical vibration and increasing temperature at rear generator bearing. Turbine taken offline. Similar acoustic signature at 120Hz recorded 3 weeks prior to P/N G-5432 bearing assembly failure.
    Action: Found catastrophic failure of bearing P/N G-5432. Replaced bearing assembly.
    Notes: Recommend reviewing vibration thresholds for 120Hz band on similar GRX-II units.

    Asset ID: DemoCorp_Turbine_007
    Date: 2024-08-01
    Work Order: WO2024080005
    Issue: Annual main bearing lubrication. Action: Nominal.

  # Key 4: The expert notes knowledge base file
  expert_technician_notes.txt: |
    Expert Technician Field Notes & Best Practices - Compiled by Lead Engineering Team
    Lead Engineer: Dr. Eva Rostova

    GRX-II Model Specific Notes:
    1. Main Bearing Wear: The GRX-II main bearing is generally robust. Look for an increase in low-frequency (1-10Hz) vibration components.

    2. Direct-Drive Generator Nuances: Analyst Note (Dr. Eva Rostova): For gearbox model GRX-II, correlate 120Hz vibration spikes with oil temperature. A rise >5°C suggests accelerated wear. The core part is the 120Hz + temp correlation.

    3. Acoustic Signatures: Experienced technicians can often identify developing issues by changes in the turbine's sound.